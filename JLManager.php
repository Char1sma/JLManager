<?php
/**
 * JLManager
 *
 * @copyright  Copyright (c) 2015 JackyLieu http://github.com/JackyLieu
 * @license    GNU General Public License 3.0
 * @version    0.2beta2
 */
	define("__PASSWORD__","1");
	define("__MENU_BUTTON__","data:image/png;base64,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");
	session_start();
	global $base_dir,$post_dir;
	global $logged;
	$base_dir=dirname(__FILE__);
	/* __DIR__是PHP5.3新增的魔术语法，代表当前文件所在路径 */
	function get_filename() {
		//取当前文件名
		$url = $_SERVER['PHP_SELF'];
		return substr($url,strrpos($url,'/')+1);
	}
	
	//POST
	if(isset($_POST['password'])) {
		//判断是否提交了密码
		if ($_POST['password'] == __PASSWORD__) {
			$_SESSION['logged'] = "yes";
		}
	}
	
	if(isset($_FILES['userfile'])) {
		//文件上传处理
		if ($_FILES['userfile']['error']>0) exit;
		if (is_uploaded_file($_FILES['userfile']['tmp_name'])) {
			if(!move_uploaded_file($_FILES['userfile']['tmp_name'],$base_dir.$post_dir."\\".$_FILES['userfile']['name'])) exit;
		}
		header("Location :".get_filename()."?dir=".$post_dir);
	}
	
	//GET
	if (isset($_GET['dir'])) {
		//如果含有GET参数dir则获取
		$post_dir = $_GET['dir'];
	}
	if (isset($_GET['logout'])) {
		session_destroy();
		header("Location: ".get_filename());
	}
	$logged = false;
	if (isset($_SESSION['logged'])) {
		//已登录
		$logged = true;
	}
?>
<html>
<head>
	<title><?php echo ($logged ? "简单文件管理" : "请登录"); ?></title>
	<meta charset="gbk">
	<style type="text/css">
	<!--
		body {margin:0;background:#79cdcd;}
		.floater {float:left;height:50%;width:1px /*解决垂直居中*/}
		.login_form {clear:both;min-width:220px;margin:auto;padding:0}
		.login_meta {float:left;margin:0;padding:5px}
		.login_btn {float:right;margin:0;padding:5px}
		.nav {width:100%;position:fixed;top:-3px;}
		.nav .menu {list-style:none;width:174px;height:30px;margin:auto;padding-left:0;padding-top:4px;background:#7cffcc;border:3px #006699 solid;}
		.nav .menu li {float:left;width:48px;margin:0 5px;text-align:center;background:transparent;font-size:1.3em}
		.nav .menu li a {text-decoration:none;}
		.nav .menu li a:hover {text-decoration:underline;}
		.file_manager {background:#ccc;width:98%;max-width:500px;height:100%;margin:auto;border:#00cccc 3px dashed;margin-top: 40px;}
		.file_manager form {margin:0}
		.upload_panel {display:none;}
		.file_list tr td{padding:5px;border:1px #00cccc dashed;background:#eee}
		.file_list .menu {display:none}
		@media screen and (max-width:532px) {
			input#userfile {width: 180px;}
		}
		@media screen and (min-width:480px) {
			body {margin:2%}
			.floater {margin-bottom:-30px}
			.login_form {height:60px;width:75%;max-width:460px}
			.login_meta {width:75%;height:40px;padding:5px}
			.login_meta input {width:99%;height:38px;font-size:30px}
			.login_btn {wdith:25%;height:50px}
			.login_btn input {margin:0;width:60px;max-width:100%;height:38px;font-size:20px}
			.upload_panel {display:block;padding:5px;border:#00cccc dashed;border-width:0 0 3px 0;background:#fff}
			.file_list tr:hover td{background:#79cdcd}
			tr.file_list_title:hover td {background:#eee}
		}
		@media screen and (min-width:320px) and (max-width: 479px) {
			body {margin:10px}
			.floater {margin-bottom:-30px}
			.login_form {height:60px;width:75%}
			.login_meta {width:60%;height:40px;padding:5px}
			.login_meta input {width:99%;height:38px;font-size:30px;}
			.login_btn {width:30%;height:50px}
			.login_btn input {margin:0;width:60px;max-width:100%;height:38px;font-size:20px}
			.file_list .menu {display:block}
			.file_list .submenu {display:none;}
		}
		@media screen and (max-width: 319px) {
			.floater {margin-bottom:-20px}
			.login_form {width:40%}
			.login_meta {margin:0;width:70%;height:30px}
			.login_meta input {width:99%;height:28px;font-size:20px}
			.login_btn {margin:0;wdith:10%;height:30px}
			.login_btn input {margin:0;height:28px;}
			.file_list .menu {display:block}
			.file_list .submenu {display:none}
		}
	-->
	</style>
<?php if ($logged) { ?>
		<div class="nav">
			<ul class="menu">
				<li class="home"><a href="<?php get_filename() ?>">主页</a></li>
				<li class="refresh"><a href="<?php echo get_filename()."?dir=".$post_dir; ?>">刷新</a></li>
				<li class="exit"><a href="<?php get_filename() ?>?logout=true">退出</a></li>
			</ul>
		</div>
<?php } ?>
</head>
<body>
<?php
	if (!$logged) {
?>
<div class="floater"></div>
<div class="login_form">
	<form action="<?php get_filename() ?>" method="post">
		<!-- 避免更改文件名导致不能登录 -->
		<div class="login_meta"><input type="password" name="password"></div>
		<div class="login_btn"><input type="submit" value="登录" /></div>
	</form>
</div>
<?php 
	} else if ($logged) {
?>
	<div style="display:none">
		<form action="<?php get_filename()."?dir=".$post_dir ?>" method="post">
			<!-- 删除文件POST FORM -->
			<input type="" />
		</form>
	</div>
	<div class="file_manager">
	<form action="<?php get_filename() ?>" method="post" enctype="multipart/form-data" />
		<div class="upload_panel">
			<label for="userfile">选择需要上传的文件:</label>
			<input type="file" name="userfile" id="userfile"/>
			<input type="submit" value="确定上传" />
		</div>
	</form>
	<table class="file_list" width="100%">
	<tbody>
		<tr class="file_list_title">
			<td width="40%">名称</td>
			<td width="20%">大小</td>
			<td width="40%">操作</td>
		</tr>
<?php
		$fileList = array();
		$fileList = scandir($base_dir.$post_dir);
		foreach($fileList as $filename) {
		if ($filename == ".") continue;
			$filesize = NULL;
			$operation = "<span class=\"menu\"><img src=\"".__MENU_BUTTON__."\" /></span>
						  <span class=\"submenu\"><a href=\"\">改名</a></span>
						  <span class=\"submenu\"><a href=\"\">删除</a></span>
						  <span class=\"submenu\"><a href=\"\">打包</a></span>
						  <span class=\"submenu\"><a href=\"\">权限</a></span>";
			switch (is_dir(str_replace("/","\\",$base_dir).str_replace("/","\\",$post_dir)."\\".$filename)) {
				case true:
				if ($filename == "..") {
					$filename = dirname($post_dir);
					$filename = "<a href=\"".get_filename()."?dir=".$filename."\">../</a>";
					break;
				}
				$filename = "<a href=\"".get_filename()."?dir=".str_replace("\\\\","\\",$post_dir."\\".$filename)."\">$filename</a>";
				//修正多添加上的"/"
				break;
				case false;
				$filesize = round(filesize($base_dir.$post_dir."\\".$filename)/1024)."KB";
				//只有文件才能用filesize取尺寸
				$filename = "<p>".$filename."</p>";
				break;
			}
			echo "<tr>
					<td>".$filename."</td>
					<td>".$filesize."</td>
					<td>".$operation."</td>
				  </tr>";
		}
	}
?>	</tbody>
	</table>
</body>
	